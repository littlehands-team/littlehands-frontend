<!-- product-detail.html -->

<!-- Loading State -->
<div *ngIf="loading" class="loading-container">
  <div class="spinner"></div>
  <p>Cargando producto...</p>
</div>

<!-- Error State -->
<div *ngIf="error && !loading" class="error-container">
  <h2>Producto no encontrado</h2>
  <p>El producto que buscas no existe o ha sido eliminado.</p>
  <button class="btn-primary" routerLink="/products">Volver a productos</button>
</div>

<!-- Product Detail -->
<div *ngIf="product && !loading" class="product-detail-container">

  <!-- Main Content -->
  <div class="product-main">

    <!-- Left Side: Image/Video Gallery -->
    <div class="product-gallery">

      <!-- Main Display (Image or Video) -->
      <div class="main-display">
        <img
          [src]="mainImageUrl"
          [alt]="product.name"
          class="main-image"
        />
      </div>

      <!-- Thumbnails (Image + Videos) -->
      <div class="thumbnails">
        <!-- Image Thumbnail -->
        <div
          class="thumbnail"
          [class.active]="selectedVideoIndex === -1"
          (click)="mainImageUrl = product.image_url; selectedVideoIndex = -1"
        >
          <img [src]="product.image_url" [alt]="product.name" />
        </div>

        <!-- Video Thumbnails -->
        <div
          *ngFor="let videoUrl of youtubeEmbedUrls; let i = index"
          class="thumbnail video-thumbnail"
          [class.active]="selectedVideoIndex === i"
          (click)="selectVideo(i)"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
        </div>
      </div>
    </div>

    <!-- Right Side: Product Info -->
    <div class="product-info">

      <h1 class="product-name">{{ product.name }}</h1>

      <p class="product-short-description">{{ product.short_description }}</p>

      <!-- Price -->
      <div class="price-section">
        <div class="price" [class.has-discount]="hasDiscount">
          <span class="final-price">{{ finalPrice | number:'1.2-2' }} €</span>
          <span *ngIf="hasDiscount" class="original-price">{{ product.price | number:'1.2-2' }} €</span>
        </div>
      </div>

      <!-- Quantity & Add to Cart -->
      <div class="cart-section">
        <div class="quantity-control">
          <span class="label">CANTIDAD</span>
          <div class="quantity-buttons">
            <button (click)="decreaseQuantity()" class="btn-quantity">-</button>
            <span class="quantity-value">{{ quantity }}</span>
            <button (click)="increaseQuantity()" class="btn-quantity">+</button>
          </div>
        </div>

        <button class="btn-add-to-cart" (click)="addToCart()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
          </svg>
          AÑADIR A LA CESTA
        </button>
      </div>

      <!-- Chatbot Section -->
      <div class="chatbot-section">
        <div class="chatbot-header">
          <h3>¿Tienes alguna duda sobre el producto?</h3>
        </div>

        <p class="chatbot-subtitle">Nuestro asistente de IA puede cometer errores. Verifica la información importante.</p>

        <!-- Chat Messages -->
        <div class="chat-messages" *ngIf="chatMessages.length > 0">
          <div
            *ngFor="let message of chatMessages"
            class="message"
            [class.user-message]="message.isUser"
            [class.bot-message]="!message.isUser"
          >
            <div class="message-bubble">
              {{ message.text }}
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div class="chat-empty" *ngIf="chatMessages.length === 0">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          <p>¿Tienes preguntas? Estoy aquí para ayudarte</p>
        </div>

        <!-- Suggested Messages -->
        <div class="suggested-messages" *ngIf="chatMessages.length === 0">
          <button
            *ngFor="let message of suggestedMessages"
            class="suggested-btn"
            (click)="selectSuggestedMessage(message)"
          >
            {{ message }}
          </button>
        </div>

        <!-- Ask Question Input -->
        <div class="ask-question">
          <input
            type="text"
            placeholder="Escribe tu pregunta..."
            [(ngModel)]="chatbotQuestion"
            (keyup.enter)="sendChatbotQuestion()"
          />
          <button (click)="sendChatbotQuestion()" class="btn-send" [disabled]="!chatbotQuestion.trim()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- Video Gallery (if selected) -->
  <div *ngIf="selectedVideoIndex >= 0" class="video-player-section">
    <h2>VIDEOS DE YOUTUBE AGREGADOS</h2>
    <iframe
      [src]="youtubeEmbedUrls[selectedVideoIndex]"
      frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
      allowfullscreen
      class="youtube-iframe"
    ></iframe>
  </div>

  <!-- Product Details Section -->
  <div class="product-details-section">
    <div class="details-header">
      <h2>CARACTERÍSTICAS DEL PRODUCTO</h2>
    </div>

    <div class="details-content">
      <p class="long-description">{{ product.long_description }}</p>

      <div class="product-specs">
        <p><strong>Edad recomendada:</strong> a partir de {{ product.age_category }}</p>
      </div>
    </div>
  </div>

  <!-- Recommended Products Section (Placeholder) -->
  <div class="recommended-section">
    <h2>COMPLETA TU COMPRA</h2>
    <div class="recommended-products">
      <!-- TODO: Implementar productos recomendados -->
      <p class="coming-soon">Productos recomendados próximamente...</p>
    </div>
  </div>

</div>
