<!-- Loading State -->
<div *ngIf="loading" class="loading-container">
  <div class="spinner"></div>
  <p>Cargando producto...</p>
</div>

<!-- Error State -->
<div *ngIf="error && !loading" class="error-container">
  <h2>Producto no encontrado</h2>
  <p>El producto que buscas no existe o ha sido eliminado.</p>
  <button class="btn-primary" routerLink="/products">Volver a productos</button>
</div>

<!-- Product Detail -->
<div *ngIf="product && !loading" class="product-detail-container">

  <!-- Main Content -->
  <div class="product-main">

    <!-- Left Side: Image/Video Gallery -->
    <div class="product-gallery">

      <!-- Main Display (Image or Video) -->
      <div class="main-display">
        <img
          [src]="mainImageUrl"
          [alt]="product.name"
          class="main-image"
        />
      </div>

      <!-- Thumbnails (Image + Videos) -->
      <div class="thumbnails">
        <!-- Image Thumbnail -->
        <div
          class="thumbnail"
          [class.active]="selectedVideoIndex === -1"
          (click)="mainImageUrl = product.image_url; selectedVideoIndex = -1"
        >
          <img [src]="product.image_url" [alt]="product.name" />
        </div>

        <!-- Video Thumbnails -->
        <div
          *ngFor="let videoUrl of youtubeEmbedUrls; let i = index"
          class="thumbnail video-thumbnail"
          [class.active]="selectedVideoIndex === i"
          (click)="selectVideo(i)"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
        </div>
      </div>
    </div>

    <!-- Right Side: Product Info -->
    <div class="product-info">

      <h1 class="main-product-name">{{ product.name }}</h1>

      <p class="product-short-description">{{ product.short_description }}</p>

      <!-- Price -->
      <div class="price-section">
        <div class="price" [class.has-discount]="hasDiscount">
          <span class="final-price">S/ {{ finalPrice | number:'1.2-2' }}</span>
          <span *ngIf="hasDiscount" class="original-price">S/ {{ product.price | number:'1.2-2' }}</span>
        </div>
      </div>

      <!-- Quantity & Add to Cart -->
      <div class="cart-section">
        <div class="quantity-control">
          <span class="label">CANTIDAD</span>
          <div class="quantity-buttons">
            <button (click)="decreaseQuantity()" class="btn-quantity">-</button>
            <span class="quantity-value">{{ quantity }}</span>
            <button (click)="increaseQuantity()" class="btn-quantity">+</button>
          </div>
        </div>

        <button class="btn-add-to-cart" (click)="addToCartMain()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
          </svg>
          AÑADIR A LA CESTA
        </button>
      </div>

      <!-- Chatbot Section -->
      <div class="chatbot-section">
        <div class="chatbot-header">
          <h3>¿Tienes alguna duda sobre el producto?</h3>
        </div>

        <p class="chatbot-subtitle">Nuestro asistente de IA puede cometer errores. Verifica la información importante.</p>

        <!-- Chat Messages Container -->
        <div class="chat-container">

          <!-- Empty State -->
          <div class="chat-empty" *ngIf="chatMessages.length === 0 && !isChatLoading">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <p>¿Tienes preguntas? Estoy aquí para ayudarte</p>
          </div>

          <!-- Chat Messages -->
          <div class="chat-messages" *ngIf="chatMessages.length > 0 || isChatLoading">
            <div
              *ngFor="let message of chatMessages"
              class="message"
              [class.user-message]="!message.isBot"
              [class.bot-message]="message.isBot">
              <div class="message-bubble">
                <div [innerHTML]="formatBotMessage(message)"></div>
              </div>
            </div>

            <!-- Typing Indicator (3 puntos) -->
            <div class="message bot-message" *ngIf="isChatLoading">
              <div class="message-bubble typing-indicator">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          </div>

        </div>

        <!-- Suggested Messages (solo cuando no hay mensajes) -->
        <div class="suggested-messages" *ngIf="chatMessages.length === 1 && !isChatLoading">
          <button
            *ngFor="let message of suggestedMessages"
            class="suggested-btn"
            (click)="selectSuggestedMessage(message)">
            {{ message }}
          </button>
        </div>

        <!-- Ask Question Input -->
        <div class="ask-question">
          <input
            type="text"
            placeholder="Escribe tu pregunta..."
            [(ngModel)]="chatbotQuestion"
            (keyup.enter)="sendChatbotQuestion()"
            [disabled]="isChatLoading" />
          <button
            (click)="sendChatbotQuestion()"
            class="btn-send"
            [disabled]="!chatbotQuestion.trim() || isChatLoading">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- Video Gallery (if selected) -->
  <div *ngIf="selectedVideoIndex >= 0 && youtubeEmbedUrls.length > 0" class="video-player-section">
    <h2>VIDEOS DE YOUTUBE AGREGADOS</h2>
    <iframe
      [src]="youtubeEmbedUrls[selectedVideoIndex]"
      frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
      allowfullscreen
      class="youtube-iframe"
    ></iframe>
  </div>

  <!-- Product Details Section -->
  <div class="product-details-section">
    <div class="details-header">
      <h2>CARACTERÍSTICAS DEL PRODUCTO</h2>
    </div>

    <div class="details-content">
      <p class="long-description">{{ product.long_description }}</p>

      <div class="product-specs">
        <p><strong>Edad recomendada:</strong> a partir de {{ product.age_category }}</p>
      </div>
    </div>
  </div>

  <!-- Recommended Products Section -->
  <div class="recommended-section">
    <h2>COMPLETA TU COMPRA</h2>

    <!-- Loading State -->
    <div *ngIf="loadingRecommendations" class="loading-recommendations">
      <div class="spinner-small"></div>
      <p>Cargando recomendaciones...</p>
    </div>

    <!-- Products Grid -->
    <div *ngIf="!loadingRecommendations && recommendedProducts.length > 0" class="recommended-products">
      <div
        *ngFor="let product of recommendedProducts"
        class="product-card"
        (click)="viewProductDetail(product)">

        <!-- Badges superiores -->
        <div class="product-badges">
          <span class="age-badge">{{ product.age_category }}</span>
          <span class="discount-badge" *ngIf="product.discount_percentage > 0">
            OFERTA
          </span>
          <span class="discount-badge secondary" *ngIf="product.discount_percentage > 0">
            -{{ product.discount_percentage }}%
          </span>
        </div>

        <!-- Imagen -->
        <div class="product-image">
          <img [src]="product.image_url" [alt]="product.name" />
        </div>

        <!-- Info del producto -->
        <div class="product-info">
          <h3 class="product-name">{{ product.name }}</h3>

          <div class="product-pricing">
            <span class="original-price" *ngIf="product.discount_percentage > 0">
              S/ {{ product.price }}
            </span>
            <span class="final-price">
              S/ {{ calculateFinalPrice(product) }}
            </span>
          </div>

          <!-- Botón de agregar al carrito -->
          <button
            class="add-to-cart-btn"
            (click)="addToCart($event, product); $event.stopPropagation()">
            <mat-icon>shopping_cart</mat-icon>
          </button>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loadingRecommendations && recommendedProducts.length === 0" class="no-recommendations">
      <p>No hay productos recomendados disponibles en este momento.</p>
    </div>
  </div>

</div>
